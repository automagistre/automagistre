version: '3.7'

services:
    oauth2-proxy:
        image: quay.io/oauth2-proxy/oauth2-proxy:v7.1.3
        labels:
            ru.grachevko.dhu: 'crm.automagistre.local:2'
        command:
            - --http-address=:80
            - --upstream=http://nginx:80
            - --reverse-proxy=true
            - --session-store-type=redis
            - --redis-connection-url=redis://redis/1
            - --cookie-secret=${OAUTH2_PROXY_COOKIE_SECRET}
            - --cookie-secure=false
            - --pass-access-token
            - --email-domain=*
            - --provider=keycloak
            - --skip-provider-button=true
            - --redirect-url=http://crm.automagistre.local/oauth2/callback
            - --scope=openid
            - --client-id=crm-oauth
            - --client-secret=${OAUTH2_PROXY_KEYCLOAK_CLIENT_SECRET}
            - --login-url=https://auth.automagistre.ru/auth/realms/automagistre/protocol/openid-connect/auth
            - --redeem-url=https://auth.automagistre.ru/auth/realms/automagistre/protocol/openid-connect/token
            - --profile-url=https://auth.automagistre.ru/auth/realms/automagistre/protocol/openid-connect/userinfo
            - --validate-url=https://auth.automagistre.ru/auth/realms/automagistre/protocol/openid-connect/userinfo
            - --whitelist-domain=.automagistre.ru
            - --whitelist-domain=.automagistre.local
            - --skip-auth-route=^/[a-z0-9]+/api/.+
            - --skip-auth-preflight

    nginx:
        image: automagistre/tenant-nginx:base
        labels:
            ru.grachevko.dhu: '{callback,r}.automagistre.local'
        volumes:
            - ./public:/usr/local/app/public
            - ./etc/nginx.conf:/etc/nginx/nginx.conf
            - ./etc/nginx.cors.conf:/etc/nginx/cors.conf
            - ./etc/nginx.cors-setup.conf:/etc/nginx/cors.setup.conf

    php-fpm:
        image: automagistre/tenant-php:base
        volumes:
            - ./:/usr/local/app
            - ./etc/php.ini:/usr/local/etc/php/php.ini
            - ./etc/php-fpm.conf:/usr/local/etc/php-fpm.conf
            - ./etc/php-fpm.www.conf:/usr/local/etc/php-fpm.d/www.conf
        environment:
            PHP_OPCACHE_ENABLE: 0
            APP_ENV: dev
            APP_DEBUG: 1

    rector:
        image: automagistre/tenant-rector:latest
        volumes:
            - ./:/project

    postgres:
        image: postgres:13.4-alpine
        labels:
            ru.grachevko.dhu: 'postgres.automagistre.local'
        volumes:
            -   type: tmpfs
                target: /var/lib/postgresql/data
                tmpfs:
                    size: 2G
            - ./:/usr/local/app
        environment:
            POSTGRES_DB: db
            POSTGRES_USER: db
            POSTGRES_PASSWORD: db

    postgres_msk: &postgres
        image: postgres:12.2
        labels:
            ru.grachevko.dhu: 'db.msk.automagistre.local'
        volumes:
            -   type: tmpfs
                target: /var/lib/postgresql/data
                tmpfs:
                    size: 2G
            - ./:/usr/local/app
        environment:
            POSTGRES_DB: db
            POSTGRES_USER: db
            POSTGRES_PASSWORD: db

    postgres_kazan:
        <<: *postgres
        labels:
            ru.grachevko.dhu: 'db.kazan.automagistre.local'

    postgres_shavlev:
        <<: *postgres
        labels:
            ru.grachevko.dhu: 'db.shavlev.automagistre.local'

    postgres_demo:
        <<: *postgres
        labels:
            ru.grachevko.dhu: 'db.demo.automagistre.local'

    memcached:
        image: memcached:1.6.9-alpine
        labels:
            ru.grachevko.dhu: 'memcached.automagistre.local'

    redis:
        image: redis:6.2.5-alpine
        labels:
            ru.grachevko.dhu: 'redis.automagistre.local'

    host.docker.internal:
        image: alpine/socat:1.7.3.4-r0
        entrypoint: sh
        command: -c "socat tcp-listen:9000,fork,reuseaddr tcp-connect:$$(/sbin/ip route|awk '/default/ { print $$3 }'):9000"

    nsqd:
        image: nsqio/nsq:v1.2.0
        command: /nsqd

    nsq_tail:
        image: nsqio/nsq:v1.2.0
        command:
            - /nsq_tail
            - -topic=symfony-messenger
            - -channel=tail
            - -nsqd-tcp-address=nsqd:4150

    nsqadmin:
        image: nsqio/nsq:v1.2.0
        command: /nsqadmin --nsqd-http-address=nsqd:4151 --http-address=0.0.0.0:80
        labels:
            ru.grachevko.dhu: 'nsq.automagistre.local'

    hasura:
        image: hasura/graphql-engine:v2.0.7
        command:
            - graphql-engine
            - serve
            - --server-port=80
            - --unauthorized-role=anonymous
            - --cors-domain=*
        environment:
            HASURA_GRAPHQL_DATABASE_URL: postgres://db:db@postgres_msk:5432/db
            HASURA_GRAPHQL_METADATA_DATABASE_URL: postgres://db:db@postgres_msk:5432/hasura
            HASURA_GRAPHQL_ENABLE_CONSOLE: 'true'
            HASURA_GRAPHQL_DEV_MODE: 'true'
            HASURA_GRAPHQL_ENABLED_LOG_TYPES: startup, http-log, webhook-log, websocket-log, query-log
            HASURA_GRAPHQL_JWT_SECRET: '{"jwk_url": "https://auth.automagistre.ru/auth/realms/automagistre/protocol/openid-connect/certs"}'
            HASURA_GRAPHQL_ADMIN_SECRET: admin
        labels:
            ru.grachevko.dhu: 'api.automagistre.local'

networks:
    default:
        name: automagistre
