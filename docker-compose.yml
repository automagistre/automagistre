version: '3.7'

services:
    react-admin:
        image: automagistre/automagistre:node-base
        extra_hosts:
            - crm-next.automagistre.local:0.0.0.0
        labels:
            ru.grachevko.dhu: 'crm-next.automagistre.local'
        command: npm run start
        environment:
            HOST: crm-next.automagistre.local
            PORT: 80
        volumes:
            - ./:/app
        working_dir: /app
        user: ${UID:-1000}:${GID:-1000}

    postgres:
        image: postgres:14.0-alpine
        labels:
            ru.grachevko.dhu: 'postgres-next.automagistre.local'
        volumes:
            -   type: tmpfs
                target: /var/lib/postgresql/data
                tmpfs:
                    size: 2G
            - ./:/app
        environment:
            POSTGRES_DB: automagistre
            POSTGRES_USER: root
            POSTGRES_PASSWORD: root
            PGDATABASE: automagistre

    redis:
        image: redis:6.2.5-alpine
        labels:
            ru.grachevko.dhu: 'redis-next.automagistre.local'
        volumes:
            -   type: tmpfs
                target: /data
                tmpfs:
                    size: 64mb

    hasura:
        image: hasura/graphql-engine:v2.1.0-beta.2.cli-migrations-v3
        labels:
            ru.grachevko.dhu: 'api-next.automagistre.local'
        command:
            - graphql-engine
            - serve
            - --server-port=80
            - --unauthorized-role=anonymous
            - --cors-domain=*
            - --admin-internal-errors=true
        environment:
            HASURA_GRAPHQL_DATABASE_URL: postgres://automagistre:automagistre@postgres:5432/automagistre
            HASURA_GRAPHQL_METADATA_DATABASE_URL: postgres://hasura:hasura@postgres:5432/automagistre
            HASURA_GRAPHQL_DEV_MODE: 'true'
            HASURA_GRAPHQL_ENABLED_LOG_TYPES: startup, http-log, webhook-log, websocket-log, query-log
            HASURA_GRAPHQL_JWT_SECRET: '{"jwk_url": "https://auth.automagistre.ru/auth/realms/automagistre/protocol/openid-connect/certs"}'
            HASURA_GRAPHQL_ADMIN_SECRET: admin
            HASURA_GRAPHQL_STRINGIFY_NUMERIC_TYPES: 'false'
        networks:
            default:
                aliases:
                    - api-next.automagistre.local

    hasura-console:
        image: hasura/graphql-engine:v2.1.0-beta.2.cli-migrations-v3
        extra_hosts:
            - api-console.automagistre.local:0.0.0.0
        labels:
            ru.grachevko.dhu: 'api-console.automagistre.local'
        entrypoint: hasura-cli
        command:
            - console
            - --address=api-console.automagistre.local
            - --console-port=80
        environment:
            HASURA_GRAPHQL_ADMIN_SECRET: admin
        working_dir: /app
        volumes:
            - ./:/app
            - ./var/hasura:/.hasura
        user: ${UID:-1000}:${GID:-1000}

    n8n:
        image: n8nio/n8n:0.148.0
        labels:
            ru.grachevko.dhu: 'n8n.automagistre.local'
        environment:
            N8N_ENCRYPTION_KEY: Iucahjohyah6eiY9
            N8N_PORT: 80
            N8N_DIAGNOSTICS_ENABLED: 'false'
        volumes:
            - ./var/n8n:/home/node/.n8n
        networks:
            default:
                aliases:
                    - n8n.automagistre.local

networks:
    default:
        name: automagistre-next
