version: '3.7'

services:
    postgres:
        image: postgres:13.4-alpine
        labels:
            ru.grachevko.dhu: 'postgres.automagistre.local'
        volumes:
            -   type: tmpfs
                target: /var/lib/postgresql/data
                tmpfs:
                    size: 2G
            - ./:/usr/local/app
        environment:
            POSTGRES_DB: db
            POSTGRES_USER: db
            POSTGRES_PASSWORD: db

    redis:
        image: redis:6.2.5-alpine
        labels:
            ru.grachevko.dhu: 'redis.automagistre.local'
        volumes:
            -   type: tmpfs
                target: /data
                tmpfs:
                    size: 64mb

    hasura:
        image: hasura/graphql-engine:v2.0.7
        command:
            - graphql-engine
            - serve
            - --server-port=80
            - --unauthorized-role=anonymous
            - --cors-domain=*
        environment:
            HASURA_GRAPHQL_DATABASE_URL: postgres://db:db@postgres:5432/db
            HASURA_GRAPHQL_METADATA_DATABASE_URL: postgres://db:db@postgres:5432/hasura
            HASURA_GRAPHQL_ENABLE_CONSOLE: 'true'
            HASURA_GRAPHQL_DEV_MODE: 'true'
            HASURA_GRAPHQL_ENABLED_LOG_TYPES: startup, http-log, webhook-log, websocket-log, query-log
            HASURA_GRAPHQL_JWT_SECRET: '{"jwk_url": "https://auth.automagistre.ru/auth/realms/automagistre/protocol/openid-connect/certs"}'
            HASURA_GRAPHQL_ADMIN_SECRET: admin
        labels:
            ru.grachevko.dhu: 'api.automagistre.local'

networks:
    default:
        name: automagistre
