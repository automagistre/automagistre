services:
    nginx:
        build:
            target: nginx-base
            context: .
        labels:
            traefik.enable: true
            traefik.http.routers.nginx.rule: Host(`crm.automagistre.local`)
            traefik.http.routers.nginx.entrypoints: web 
            traefik.http.services.nginx.loadbalancer.server.port: 80
        environment:
            PHP_FPM_HOST: php-fpm
        volumes:
            - ./public:/usr/local/app/public
            - ./etc/nginx.conf:/etc/nginx/nginx.conf
            - ./etc/nginx.default.conf:/etc/nginx/templates/default.conf.template
            - ./etc/nginx.cors.conf:/etc/nginx/cors.conf
            - ./etc/nginx.cors-setup.conf:/etc/nginx/cors.setup.conf
        networks:
            - default
            - web

    php-fpm:
        build:
            target: php-base
            context: .
        volumes:
            - ./:/usr/local/app
            - ./etc/php.ini:/usr/local/etc/php/php.ini
            - ./etc/php-fpm.conf:/usr/local/etc/php-fpm.conf
            - ./etc/php-fpm.www.conf:/usr/local/etc/php-fpm.d/www.conf
        environment:
            PHP_OPCACHE_ENABLE: 0
            APP_ENV: dev
            APP_DEBUG: 1
            NSQ_HOST: nsqd
        user: ${UID:-1000}:${GID:-1000}

    postgres:
        image: postgres:14.2-alpine
        volumes:
            -   type: tmpfs
                target: /var/lib/postgresql/data
                tmpfs:
                    size: 2G
            - ./:/usr/local/app
        environment:
            POSTGRES_DB: db
            POSTGRES_USER: db
            POSTGRES_PASSWORD: db
        ports:
          - 5432:5432

    redis:
        image: redis:6.2.5-alpine
        volumes:
            -   type: tmpfs
                target: /data
                tmpfs:
                    size: 64mb

    nsqd:
        image: nsqio/nsq:v1.2.1
        restart: always
        command:
            - /nsqd
            - -data-path=/data
            - -max-heartbeat-interval=2m
            - -msg-timeout=2m
        ports:
            - "4150:4150"
            - "4151:4151"
        volumes:
            - type: bind
              source: ../../data/automagistre/nsq
              target: /data

    host.docker.internal:
        image: alpine/socat:1.7.3.4-r0
        entrypoint: sh
        command: -c "socat tcp-listen:9000,fork,reuseaddr tcp-connect:$$(/sbin/ip route|awk '/default/ { print $$3 }'):9000"


networks:
    default:
        name: automagistre
        attachable: true
    web:
        name: traefik
        external: true
                  
