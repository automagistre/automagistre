{% extends 'easy_admin/default/show.html.twig' %}


{% block question %}
    <h3>Вопрос с сайта от клиента</h3>
    <hr>
    <div style="max-width: 1024px">
        <p>{{ appeal.question }}</p>
    </div>
    <small style="color: #929292">На данную заявку можно ответить только по e-mail</small>
{% endblock %}

{% block cooperation %}
    <h3>Клиент запросил обслуживание Юридического лица</h3>
    <hr>
    <small style="color: #929292">Данную заяву должно обработать лицо ответсвенное за корпортивное обслуживание</small>
{% endblock %}

{% block schedule %}
    <h3>Заявка на запись</h3>
    <hr>
    <p>Клиент хочет записаться на ремонт <b>{{ date(appeal.date, 'Europe/Moscow')|format_date('short') }}</b></p>
    <small style="color: #929292">Для уточнения подробностей записи нужно позвонить клиенту</small>
{% endblock %}

{% block tireFitting %}
    <h3>Запись на шиномонтаж</h3>
    <div style="display: grid; grid-auto-columns: max-content; grid-auto-flow: dense; gap: 30px">
        <div>
            <h4>Автомобиль</h4>
            <hr>
            <table class="table">
                <caption>Данные которые клиент отметил</caption>
                <thead></thead>
                <tbody>
                    <tr>
                        <td>Автомобиль</td>
                        <td>{{ appeal.modelId }}</td>
                    </tr>
                    <tr>
                        <td>Типа кузова</td>
                        <td>{{ appeal.bodyType }}</td>
                    </tr>
                    <tr>
                        <td>Диаметер</td>
                        <td>{{ appeal.diameter }}</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div>
            <h4>Работы</h4>
            <hr>
            <table class="table" style="min-width: 560px">
                <caption>Список заявленных работ</caption>
                <thead></thead>
                <tbody>
                {% for work in appeal.works %}
                    <tr>
                        <td>{{ work.name }}</td>
                        <td>{{ work.price / 100 }}</td>
                    </tr>

                {% endfor %}
                <tr class="active">
                    <td style="text-align: right"><b>ИТОГО</b></td>
                    <td><b>{{ appeal.total|localize_money(true)|number_format(0, '.', ' ') }}</b></td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
{% endblock %}

{% block worktable %}
    <tr style="text-decoration: {{ work.isSelected ? 'none' : 'line-through' }}">
        <td colspan="2"><b>{{ work.name }}</b></td>
        <td><b>{{ work.price / 100 }}</b></td>
    </tr>
    {% for part in work.parts %}
        <tr style="text-decoration: {{ part.isSelected ? 'none' : 'line-through' }}">
            <td style="text-align: right">{{ part.name }}</td>
            <td>{{ part.price/100 }} x {{ part.count }}</td>
            <td>{{ part.price * part.count / 100 }}</td>
        </tr>
    {% endfor %}
{% endblock %}

{% block calculator %}
    <h3>Запись на Техническое Обслуживание(ТО)</h3>
    <hr>
    <div style="margin: 30px 0 50px 0">
        <h4>Автомобиль</h4>
        <hr>
        <table class="table" style="max-width: 560px">
            <caption>Данные которые клиент отметил</caption>
            <thead></thead>
            <tbody>
            <tr>
                <td>Автомобиль</td>
                <td>{{ appeal.equipmentId }}</td>
            </tr>
            <tr>
                <td>Номер ТО</td>
                <td>ТО{{ appeal.mileage }}</td>
            </tr>
            <tr>
                <td>Удобное время</td>
                <td><b>{{ date(appeal.date, 'Europe/Moscow')|format_date('short') }}</td>
            </tr>
            {% if appeal.note %}
                <tr>
                    <td>Доп. информация</td>
                    <td>{{ appeal.note }} </td>
                </tr>
            {% endif %}
            </tbody>
        </table>
    </div>
    <h4>Выбранные Работы</h4>
    <hr>
    <div style="display: flex; flex-wrap: wrap; gap: 30px">
        <div>
            <table class="table" style="min-width: 560px">
                <caption>Обязательное ТО</caption>
                <thead></thead>
                {% for work in appeal.works %}
                    {% if work.type == 'work' %}
                        {{ block('worktable') }}
                    {% endif %}
                {% endfor %}
            </table>
        </div>

        <div>
            <table class="table" style="min-width: 560px">
                <caption>Рекомендованные работы</caption>
                <thead></thead>
                {% for work in appeal.works %}
                    {% if work.type != 'work' %}
                        {{ block('worktable') }}
                   {% endif %}
                {% endfor %}
            </table>
        </div>
    </div>

    {% set totalWorks = 0 %}
    {% set totalRec = 0 %}
    {% for work in appeal.works %}
        {% if work.isSelected %}
            {% set totalParts = 0 %}
            {% for part in work.parts %}
                {% if part.isSelected %} {% set totalParts = totalParts + part.price * part.count %} {% endif %}
            {% endfor %}
            {% if work.type == 'work'%}
                {% set totalWorks = totalWorks + work.price + totalParts %}
            {% elseif work.type == 'recommendation' %}
                {% set totalRec = totalRec + work.price + totalParts %}
            {% endif %}
        {% endif %}
    {% endfor %}
    <div>
        <h4>ИТОГО</h4>
        <hr>
        <table class="table" style="max-width: 560px">
            <tbody>
                <tr>
                    <td>Итого основное ТО</td>
                    <td>{{ totalWorks / 100 }}</td>
                </tr>
                <tr>
                    <td>Итого Доп. работы</td>
                    <td>{{ totalRec / 100 }}</td>
                </tr>
                <tr class="active" style="font-weight: 700">
                    <td>Расчитанная стоимость</td>
                    <td>{{ (totalWorks + totalRec) / 100 }}</td>
                </tr>
                <tr>
                    <td>Стоимость клиента</td>
                    <td>{{ appeal.total|localize_money(true)|number_format(0, '.', ' ') }}</td>
                </tr>
            </tbody>
        </table>
    </div>
{% endblock %}

{% block main %}
    <div class="row">
        <div class="col-md-6">
            {{ parent() }}
        </div>
        <div class="col-md-6">
            {% set nextStatus = entity.status.next() %}
            <a href="{{ easyadmin_path('Appeal', 'status', {'appeal_id': entity|toId, 'status': nextStatus.toId(), 'referer': true}) }}" class="btn btn-{{ nextStatus.to('color') }}">
                Сменить статус на: {{ nextStatus.toDisplayName() }}
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="field-group">
                <div class="box box-default">
                    <div class="box-header with-border">
                        <h3 class="box-title"></h3>
                    </div>
                    <div class="box-body">
                        {% if entity.type.isCalculator() %}
                            {{ block('calculator') }}
                        {% elseif entity.type.isCooperation() %}
                            {{ block('cooperation') }}
                        {% elseif entity.type.isQuestion() %}
                            {{ block('question') }}
                        {% elseif entity.type.isSchedule() %}
                            {{ block('schedule') }}
                        {% elseif entity.type.isTireFitting() %}
                            {{ block('tireFitting') }}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock main %}
